# OpenAI Batch API Integration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Integrate OpenAI Batch API to parallelize recipe data and image generation for 50% cost savings and faster processing.

**Architecture:** Add `generateDataAndImageBatch()` method that creates JSONL with both requests, uploads to OpenAI, submits batch, polls for completion (5-min timeout), and returns both results. Update recipe APIs to use this method instead of chaining separate calls.

**Tech Stack:** OpenAI SDK (batches, files), TypeScript, Vercel Functions, Notion API

---

## Task 1: Add Batch API Helper - JSONL Creation

**Files:**
- Modify: `lib/shared/openai.ts`

**Step 1: Add helper to create JSONL content**

Add after the existing `generateData` function:

```typescript
interface BatchRequest {
  custom_id: string;
  method: string;
  url: string;
  body: Record<string, unknown>;
}

const createBatchJsonl = (requests: BatchRequest[]): string => {
  return requests.map((req) => JSON.stringify(req)).join("\n");
};
```

**Step 2: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 3: Commit**

```bash
git add lib/shared/openai.ts
git commit -m "feat: add JSONL creation helper for batch requests

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 2: Add Batch API Helper - Polling Logic

**Files:**
- Modify: `lib/shared/openai.ts`

**Step 1: Add sleep utility**

Add near the top of the file after imports:

```typescript
const sleep = (ms: number): Promise<void> =>
  new Promise((resolve) => setTimeout(resolve, ms));
```

**Step 2: Add batch polling function**

Add after `createBatchJsonl`:

```typescript
const pollBatchUntilComplete = async (
  openai: OpenAI,
  batchId: string,
  maxPollTimeMs: number = 5 * 60 * 1000, // 5 minutes
  pollIntervalMs: number = 10 * 1000, // 10 seconds
): Promise<string> => {
  const startTime = Date.now();

  while (Date.now() - startTime < maxPollTimeMs) {
    const batch = await openai.batches.retrieve(batchId);

    if (batch.status === "completed") {
      if (!batch.output_file_id) {
        throw new Error("Batch completed but no output file ID");
      }
      return batch.output_file_id;
    }

    if (batch.status === "failed") {
      const errors = batch.errors ? JSON.stringify(batch.errors) : "Unknown error";
      throw new Error(`Batch failed: ${errors}`);
    }

    if (batch.status === "expired") {
      throw new Error("Batch expired before completion");
    }

    await sleep(pollIntervalMs);
  }

  throw new Error("Batch timeout - taking longer than expected");
};
```

**Step 3: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 4: Commit**

```bash
git add lib/shared/openai.ts
git commit -m "feat: add batch polling logic with timeout handling

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 3: Add Main Batch Method - Structure

**Files:**
- Modify: `lib/shared/openai.ts`

**Step 1: Add main batch method signature**

Add after `generateData` function:

```typescript
export const generateDataAndImageBatch = async <T extends ResponseFormatTextConfig>({
  input,
  instructions,
  format,
}: {
  input: string;
  instructions: string;
  format: T;
}): Promise<{
  data: NonNullable<
    ParsedResponse<
      ExtractParsedContentFromParams<{
        input: string;
        instructions: string;
        model: "gpt-5-mini";
        text: { format: T };
      }>
    >["output_parsed"]
  >;
  imageB64: string;
}> => {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

  try {
    // Step 1: Create JSONL with both requests
    const dataRequest: BatchRequest = {
      custom_id: "recipe-data",
      method: "POST",
      url: "/v1/responses/parse",
      body: {
        input,
        instructions,
        model: "gpt-5-mini",
        text: { format },
      },
    };

    const imageRequest: BatchRequest = {
      custom_id: "recipe-image",
      method: "POST",
      url: "/v1/images/generate",
      body: {
        model: "gpt-image-1.5",
        prompt: input,
        size: "1024x1024",
        response_format: "b64_json",
      },
    };

    const jsonlContent = createBatchJsonl([dataRequest, imageRequest]);

    // Placeholder - will implement file upload next
    throw new Error("Not implemented yet");
  } catch (err) {
    throw new Error("Failed to generate data and image batch", { cause: err });
  }
};
```

**Step 2: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 3: Commit**

```bash
git add lib/shared/openai.ts
git commit -m "feat: add generateDataAndImageBatch method structure

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 4: Implement File Upload and Batch Submission

**Files:**
- Modify: `lib/shared/openai.ts`

**Step 1: Add file upload and batch creation**

Replace the `throw new Error("Not implemented yet");` line in `generateDataAndImageBatch` with:

```typescript
    // Step 2: Upload JSONL file
    const fileBuffer = Buffer.from(jsonlContent, "utf-8");
    const file = await openai.files.create({
      file: new File([fileBuffer], "batch.jsonl", { type: "application/jsonl" }),
      purpose: "batch",
    });

    // Step 3: Create batch
    const batch = await openai.batches.create({
      input_file_id: file.id,
      endpoint: "/v1/responses/parse",
      completion_window: "24h",
    });

    // Step 4: Poll for completion
    const outputFileId = await pollBatchUntilComplete(openai, batch.id);

    // Placeholder - will implement result parsing next
    throw new Error("Result parsing not implemented yet");
```

**Step 2: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 3: Commit**

```bash
git add lib/shared/openai.ts
git commit -m "feat: implement file upload and batch submission

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 5: Implement Result Parsing

**Files:**
- Modify: `lib/shared/openai.ts`

**Step 1: Add result parsing logic**

Replace the `throw new Error("Result parsing not implemented yet");` line with:

```typescript
    // Step 5: Download and parse results
    const resultsContent = await openai.files.content(outputFileId);
    const resultsText = await resultsContent.text();
    const resultLines = resultsText.trim().split("\n");

    let parsedData: NonNullable<ParsedResponse<ExtractParsedContentFromParams<{
      input: string;
      instructions: string;
      model: "gpt-5-mini";
      text: { format: T };
    }>>["output_parsed"]> | null = null;
    let imageB64: string | null = null;

    for (const line of resultLines) {
      const result = JSON.parse(line);

      if (result.custom_id === "recipe-data") {
        if (result.error) {
          throw new Error(`Data generation failed: ${JSON.stringify(result.error)}`);
        }
        parsedData = result.response.body.output_parsed;
      }

      if (result.custom_id === "recipe-image") {
        if (result.error) {
          throw new Error(`Image generation failed: ${JSON.stringify(result.error)}`);
        }
        imageB64 = result.response.body.data?.[0]?.b64_json;
      }
    }

    if (!parsedData) {
      throw new Error("No parsed data returned from batch");
    }

    if (!imageB64) {
      throw new Error("No image data returned from batch");
    }

    return { data: parsedData, imageB64 };
```

**Step 2: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 3: Commit**

```bash
git add lib/shared/openai.ts
git commit -m "feat: implement batch result parsing

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 6: Extract Image Upload Helper

**Files:**
- Modify: `lib/shared/recipes.ts`

**Step 1: Find uploadImageToNotion function**

Run: `grep -n "uploadImageToNotion" lib/shared/recipes.ts`
Expected: Find the function definition

**Step 2: Check if function is already exported**

Look at the function - if it's not exported, add `export` keyword to make it:

```typescript
export const uploadImageToNotion = async (
  // ... existing parameters
```

**Step 3: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 4: Commit if changes made**

```bash
git add lib/shared/recipes.ts
git commit -m "refactor: export uploadImageToNotion for reuse

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 7: Update Recipe Creation API

**Files:**
- Modify: `api/recipes/index.ts`

**Step 1: Update import to include new batch method**

Change the import from `lib/shared/openai.js` (around line 19):

```typescript
import { generateDataAndImageBatch } from "../../lib/shared/openai.js";
```

**Step 2: Update import from recipes.ts**

Add `uploadImageToNotion` to the import from `lib/shared/recipes.js` (around line 13):

```typescript
import {
  buildRecipeNotionProperties,
  uploadImageToNotion,
} from "../../lib/shared/recipes.js";
```

**Step 3: Replace generateData and generateRecipeImage calls**

Replace lines 98-109 with:

```typescript
    waitUntil(
      generateDataAndImageBatch({
        format,
        input: prompt,
        instructions:
          "You are a helpful assistant that provides detailed cooking recipes based on user prompts. All the instructions and details should be should be clear, concise, and easy to follow.",
      }).then(async ({ data: recipe, imageB64 }) => {
        const fileUploadId = await uploadImageToNotion(imageB64, recipe.title);
        const cover = {
          file_upload: { id: fileUploadId },
          type: "file_upload" as const,
        };
        return createRecipe(recipe, cover, db);
      }),
    );
```

**Step 4: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 5: Commit**

```bash
git add api/recipes/index.ts
git commit -m "feat: use batch API for recipe creation

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 8: Update Recipe Modification API

**Files:**
- Modify: `api/recipes/modify/index.ts`

**Step 1: Update imports**

Change the import from `lib/shared/openai.js` (around line 22):

```typescript
import { generateDataAndImageBatch } from "../../../lib/shared/openai.js";
```

Add `uploadImageToNotion` to imports from `lib/shared/recipes.js` (around line 11):

```typescript
import {
  buildRecipeNotionProperties,
  uploadImageToNotion,
} from "../../../lib/shared/recipes.js";
```

**Step 2: Replace recipe generation logic**

Replace lines 39-54 in `updateRecipeAndComment` function with:

```typescript
  const { data: updatedRecipe, imageB64 } = await generateDataAndImageBatch({
    format,
    input: modificationRequest,
    instructions: modificationPrompt,
  });

  if (!updatedRecipe) {
    throw new Error("Failed to generate updated recipe");
  }

  const notionProperties = buildRecipeNotionProperties(updatedRecipe);
  notionProperties.Name = {
    title: [{ text: { content: updatedRecipe.title } }],
  };

  const fileUploadId = await uploadImageToNotion(imageB64, updatedRecipe.title);
  const cover = {
    file_upload: { id: fileUploadId },
    type: "file_upload" as const,
  };

  await updatePage(pageId, cover, notionProperties);
```

**Step 3: Verify TypeScript compiles**

Run: `npm run build`
Expected: SUCCESS with no errors

**Step 4: Commit**

```bash
git add api/recipes/modify/index.ts
git commit -m "feat: use batch API for recipe modification

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 9: Manual Integration Test

**Files:**
- None (manual testing)

**Step 1: Test recipe creation**

Run: `vercel dev` (or your local dev command)

Make a request:
```bash
curl "http://localhost:3000/api/recipes?db=YOUR_DB_ID&prompt=make%20me%20pasta%20carbonara"
```

Expected:
- Response: "Recipe creation in progress"
- Check Notion database after a few minutes for new recipe with image

**Step 2: Test recipe modification**

Trigger a recipe modification via Notion comment with `#modify` tag.

Expected:
- Modified recipe appears in Notion with new image

**Step 3: Verify logs**

Check Vercel logs or local console for:
- Batch creation messages
- Polling messages
- No errors

**Step 4: Document test results**

Note any issues or successful completion in git commit message for next step.

---

## Task 10: Final Commit and Branch Push

**Files:**
- None

**Step 1: Verify all changes are committed**

Run: `git status`
Expected: "nothing to commit, working tree clean"

**Step 2: Push branch to remote**

Run: `git push -u origin feature/batch-api-integration`
Expected: Branch pushed successfully

**Step 3: Verify build passes**

Check CI/CD pipeline if configured.
Expected: All checks pass

---

## Notes

- **Testing:** This plan focuses on integration testing due to the nature of external API calls. Consider adding unit tests for helper functions (createBatchJsonl, pollBatchUntilComplete) if desired.
- **Error handling:** All errors propagate to existing error handlers in recipe APIs.
- **Backward compatibility:** Original `generateImage` and `generateData` methods remain unchanged.
- **Future:** Can add Cron worker if 5-minute timeout proves insufficient.

## Success Criteria

- [ ] Recipe creation uses batch API and completes within 5 minutes
- [ ] Recipe modification uses batch API and completes within 5 minutes
- [ ] Both recipe data and image are generated correctly
- [ ] Notion pages are created/updated with correct data and images
- [ ] No breaking changes to existing functionality
- [ ] TypeScript compiles without errors
